# yaml-language-server: $schema=https://esa.gitlab.io/pyxel/doc/latest/pyxel_schema.json

##########################################################################################
# Pyxel configuration file                                                               #
# Generated by Pyxel version 2.13+23.gda527f02                                           #
#                                                                                        #
# Usage from Python:                                                                     #
#  >>> import pyxel                                                                      #
#  >>> cfg = pyxel.load('config.yaml')                                                   #
#  >>> result = pyxel.run_mode(cfg)                                                      #
##########################################################################################

##########################################################################################
# Exposure running mode                                                                  #
# More information here:                                                                 #
#   https://esa.gitlab.io/pyxel/doc/stable/background/running_modes/exposure_mode.html   #
##########################################################################################
exposure:

  readout:
    times:  # Unit: [s]
      - 1.0
      - 2.0
      - 3.0
    start_time: 0.0  # Unit: [s]
    non_destructive: true

  outputs: null
  result_type: all
  pipeline_seed: 12345
  working_directory: null

# Define detector to use
ccd_detector:

  geometry:
    row: 2  # Unit: [pix]
    col: 3  # Unit: [pix]
    total_thickness: 40.0  # Unit: [µm]
    pixel_vert_size: 18.0  # Unit: [µm]
    pixel_horz_size: 18.0  # Unit: [µm]
    pixel_scale: 0.01  # Unit: [arcsec / pix]

  environment:
    temperature: 173.0  # Unit: [K]
    wavelength: null  # Unit: [nm]

  characteristics:
    quantum_efficiency: 0.8
    charge_to_volt_conversion: 1.0e-06  # Unit: [V / e⁻]
    pre_amplification: 100.0  # Unit: [V / V]
    full_well_capacity: 100000  # Unit: [e⁻]
    adc_bit_resolution: 16  # Unit: [bit]
    adc_voltage_range:  # Unit: [V]
      - 0.0
      - 10.0

##########################################################################################
# Define Pipeline                                                                        #
# More information here: https://esa.gitlab.io/pyxel/doc/stable/background/pipeline.html #
##########################################################################################
pipeline:

# Generate and manipulate photon flux within the `Photon` bucket
# -> Photon [photon]
  photon_collection:

    # Add photons by applying USAF-1951 illumination pattern
    - func: pyxel.models.photon_collection.usaf_illumination
      name: usaf_illumination
      enabled: true
      arguments:
        position:
          - 0
          - 0
        convert_to_photons: true
        bit_resolution: 8
        multiplier: 1000.0

    # Convolve photons with a PSF
    - func: pyxel.models.photon_collection.optical_psf
      name: optical_psf
      enabled: false
      arguments:
        fov_arcsec: 5
        wavelength: 600  # Unit: [nm]
        apply_jitter: true
        jitter_sigma: 0.5
        optical_system:
          - item: CircularAperture
            radius: 3.0

# Generate and manipulate charge in electrons within the `Charge` bucket
# Photon [photon] -> Charge [e⁻]
  charge_generation:

    # Generate charges (in e⁻) from incident photon via simple photoelectric effect
    - func: pyxel.models.charge_generation.simple_conversion
      name: simple_conversion
      enabled: true

    # Generate Cosmic rays effects (in e⁻) using CosmiX model
    - func: pyxel.models.charge_generation.cosmix
      name: cosmix
      enabled: false
      arguments:
        simulation_mode: cosmic_ray
        running_mode: stepsize
        particle_type: proton
        initial_energy: 200.0
        particles_per_second: 100  # Unit: [s]
        incident_angles: null
        starting_position: null
        spectrum_file: null
        progressbar: false

# Transfer and manipulate charge in electrons stored in the `Pixel` bucket
# Charge [e⁻] -> Pixel [e⁻]
  charge_collection:

    # Collect charges (in e⁻) by assigning them to nearest pixels (in e⁻)
    - func: pyxel.models.charge_collection.simple_collection
      name: simple_collection
      enabled: true

    # Clip pixel charges (in e⁻) to Full Well Capacity
    - func: pyxel.models.charge_collection.simple_full_well
      name: simple_full_well
      enabled: true

# Convert and manipulate signal in Volt stored in the `Signal` bucket
# Pixel [e⁻] -> Signal [V]
  charge_measurement:

    # Convert pixel charges (in e⁻) to Signal (in V)
    - func: pyxel.models.charge_measurement.simple_measurement
      name: simple_measurement
      enabled: true

# Convert and manipulate signal into image data in ADUs in the `Image` bucket
# Signal [V] -> Image [adu]
  readout_electronics:

    # Amplify signal (in V) using gain factors from output amplifier
    - func: pyxel.models.readout_electronics.simple_amplifier
      name: simple_amplifier
      enabled: true

    # Convert signal (in V) to image (in ADU) using ideal ADC
    - func: pyxel.models.readout_electronics.simple_adc
      name: simple_adc
      enabled: true